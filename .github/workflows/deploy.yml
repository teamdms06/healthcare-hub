name: Build and Deploy to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Use Node.js 18.x
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies (npm ci || npm install fallback)
        run: |
          set -euxo pipefail
          echo "Running on Runner: $(uname -a)"
          echo "Node: $(node -v)  npm: $(npm -v)"
          if [ -f package-lock.json ]; then
            echo "package-lock.json found -> trying npm ci"
            if npm ci --prefer-offline --no-audit --progress=false; then
              echo "npm ci succeeded"
            else
              echo "npm ci failed â€” trying npm install with legacy-peer-deps"
              npm install --legacy-peer-deps --no-audit --progress=false
            fi
          else
            echo "No package-lock.json -> running npm install (legacy-peer-deps)"
            npm install --legacy-peer-deps --no-audit --progress=false
          fi

      - name: Build
        run: |
          set -euxo pipefail
          # Change this if your build command differs
          npm run build

      - name: Locate build output
        id: locate
        run: |
          set -euxo pipefail
          # prefer Vite output (dist) then CRA (build)
          if [ -d "./dist" ]; then
            echo "build_dir=dist" >> $GITHUB_OUTPUT
          elif [ -d "./build" ]; then
            echo "build_dir=build" >> $GITHUB_OUTPUT
          else
            echo "No build output folder found. Listing repo root for debugging:"
            ls -la
            exit 1
          fi

      - name: Show build output (debug)
        run: |
          echo "Using build_dir: ${{ steps.locate.outputs.build_dir }}"
          ls -la "${{ steps.locate.outputs.build_dir }}" | sed -n '1,200p'

      - name: Prepare SSH key (write + convert + fingerprint)
        env:
          SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
        run: |
          set -euxo pipefail
          if [ -z "${SSH_KEY:-}" ]; then
            echo "EC2_SSH_KEY secret is empty. Aborting."
            exit 1
          fi

          mkdir -p ~/.ssh
          # write private key exactly as stored in secret
          printf "%s\n" "$SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          # Convert to PEM if needed (OpenSSH -> PEM). If conversion fails, continue.
          if ssh-keygen -p -f ~/.ssh/id_rsa -N "" -m PEM 2>/dev/null; then
            echo "Converted private key to PEM format (if needed)."
          else
            echo "Key conversion skipped or failed (likely already PEM)."
          fi

          # derive public and show fingerprint so you can verify the runner key matches server
          ssh-keygen -y -f ~/.ssh/id_rsa > ~/.ssh/id_rsa.pub
          echo "Runner key fingerprint:"
          ssh-keygen -lf ~/.ssh/id_rsa.pub

          # add remote host key to known_hosts to avoid interactive prompt
          if [ -n "${EC2_HOST:-}" ]; then
            ssh-keyscan -H "${EC2_HOST}" >> ~/.ssh/known_hosts || true
          fi

      - name: Deploy build to EC2 (rsync -> symlink -> reload)
        env:
          BUILD_DIR: ${{ steps.locate.outputs.build_dir }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_REMOTE_BASE: ${{ secrets.EC2_REMOTE_BASE }}
          EC2_PORT: ${{ secrets.EC2_SSH_PORT }}
        run: |
          set -euxo pipefail

          # Sanity checks
          if [ -z "${EC2_HOST:-}" ] || [ -z "${EC2_USER:-}" ] || [ -z "${EC2_REMOTE_BASE:-}" ]; then
            echo "One of EC2_HOST, EC2_USER, EC2_REMOTE_BASE is not set. Aborting."
            exit 1
          fi

          TIMESTAMP=$(date -u +"%Y%m%dT%H%M%SZ")
          RELEASE_DIR="${EC2_REMOTE_BASE}/releases/${TIMESTAMP}"
          SSH_OPTS=""
          if [ -n "${EC2_PORT:-}" ]; then SSH_OPTS="-p ${EC2_PORT}"; fi

          echo "Creating remote release directory: ${RELEASE_DIR}"
          ssh ${SSH_OPTS} -i ~/.ssh/id_rsa ${EC2_USER}@${EC2_HOST} "mkdir -p ${RELEASE_DIR} && chown -R ${EC2_USER}:${EC2_USER} ${EC2_REMOTE_BASE} || true"

          echo "Starting rsync from ${BUILD_DIR}/ to ${EC2_USER}@${EC2_HOST}:${RELEASE_DIR}/"
          rsync -az --delete --chmod=Du=rwx,Dg=rx,Do=rx,Fu=rw,Fg=r -e "ssh -i ~/.ssh/id_rsa ${SSH_OPTS} -o StrictHostKeyChecking=yes" "${BUILD_DIR}/" "${EC2_USER}@${EC2_HOST}:${RELEASE_DIR}/"

          echo "Swapping symlink to new release and reloading nginx"
          SWAP_CMD="ln -sfn ${RELEASE_DIR} ${EC2_REMOTE_BASE}/current && chown -h ${EC2_USER}:${EC2_USER} ${EC2_REMOTE_BASE}/current && chown -R ${EC2_USER}:${EC2_USER} ${RELEASE_DIR} && sudo systemctl reload nginx || sudo nginx -s reload"

          if [ -n "${EC2_PORT:-}" ]; then
            ssh -i ~/.ssh/id_rsa -p ${EC2_PORT} ${EC2_USER}@${EC2_HOST} "${SWAP_CMD}"
          else
            ssh -i ~/.ssh/id_rsa ${EC2_USER}@${EC2_HOST} "${SWAP_CMD}"
          fi

      - name: Cleanup (remove id file from runner)
        if: always()
        run: |
          set -euxo pipefail
          rm -f ~/.ssh/id_rsa || true
          rm -f ~/.ssh/id_rsa.pub || true

